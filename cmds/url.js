const fs = require("fs");  
const axios = require("axios");  
const path = require("path");  

// File to store URL detection status
const statusFile = path.join(__dirname, "url_status.json");

// Function to check if URL detection is enabled
function isUrlEnabled() {
    if (!fs.existsSync(statusFile)) return true; // Default: ON
    const statusData = JSON.parse(fs.readFileSync(statusFile, "utf8"));
    return statusData.enabled;
}

// Function to update URL detection status
function setUrlStatus(enabled) {
    fs.writeFileSync(statusFile, JSON.stringify({ enabled }));
}

module.exports = {  
    name: "url",  
    usePrefix: true,  
    usage: "!url on/off | Detects and downloads videos from TikTok, Instagram, and Facebook",  
    version: "1.7",  

    async execute(api, event, args) {  
        const { threadID, messageID, body } = event;  

        // Handle turning URL detection on/off
        if (args.length > 0) {
            const cmd = args[0].toLowerCase();
            if (cmd === "on") {
                setUrlStatus(true);
                return api.sendMessage("‚úÖ URL detection is now **ON**.", threadID, messageID);
            }
            if (cmd === "off") {
                setUrlStatus(false);
                return api.sendMessage("‚ùå URL detection is now **OFF**.", threadID, messageID);
            }
        }

        // Check if URL detection is enabled
        if (!isUrlEnabled()) return;

        const urlRegex = /(https?:\/\/[^\s]+)/gi;  
        const foundUrls = body.match(urlRegex);  
        if (!foundUrls) return;  

        const videoUrl = foundUrls[0];  

        // Check if the URL is from a supported platform  
        let platform = "";  
        if (videoUrl.includes("tiktok.com")) {  
            platform = "üé∂ TikTok";  
        } else if (videoUrl.includes("instagram.com")) {  
            platform = "üì∑ Instagram";  
        } else if (videoUrl.includes("facebook.com")) {  
            platform = "üìò Facebook";  
        } else {  
            return; // Ignore unsupported URLs  
        }  

        // Send detected URL message  
        api.sendMessage(`üîç **Detected URL:** ${videoUrl}\nüëâ Platform: **${platform}**`, threadID, async () => {  
            api.setMessageReaction("‚è≥", messageID, () => {}, true);  

            const apiUrl = `https://apis-i26b.onrender.com/download?url=${encodeURIComponent(videoUrl)}`;  

            try {  
                const response = await axios.get(apiUrl, {  
                    headers: { "User-Agent": "Mozilla/5.0" },  
                });  

                if (!response.data.success || !response.data.data.url) {  
                    api.setMessageReaction("‚ùå", messageID, () => {}, true);  
                    return api.sendMessage("‚ö†Ô∏è Failed to fetch video.", threadID, messageID);  
                }  

                const videoDownloadUrl = response.data.data.url;  
                const filePath = path.join(__dirname, "downloaded_video.mp4");  

                const writer = fs.createWriteStream(filePath);  
                const videoResponse = await axios({  
                    url: videoDownloadUrl,  
                    method: "GET",  
                    responseType: "stream",  
                    headers: { "User-Agent": "Mozilla/5.0" },  
                });  

                videoResponse.data.pipe(writer);  

                writer.on("finish", async () => {  
                    api.setMessageReaction("‚úÖ", messageID, () => {}, true);  

                    const msg = {  
                        body: `üé• Here is your video from **${platform}**!`,  
                        attachment: fs.createReadStream(filePath),  
                    };  

                    api.sendMessage(msg, threadID, (err) => {  
                        if (err) {  
                            console.error("‚ùå Error sending video:", err);  
                            return api.sendMessage("‚ö†Ô∏è Failed to send video.", threadID);  
                        }  

                        fs.unlink(filePath, (unlinkErr) => {  
                            if (unlinkErr) console.error("‚ùå Error deleting file:", unlinkErr);  
                        });  
                    });  
                });  

                writer.on("error", (err) => {  
                    console.error("‚ùå Error downloading video:", err);  
                    api.setMessageReaction("‚ùå", messageID, () => {}, true);  
                    api.sendMessage("‚ö†Ô∏è Failed to download video.", threadID, messageID);  
                });  

            } catch (error) {  
                console.error("‚ùå Error fetching video:", error);  
                api.setMessageReaction("‚ùå", messageID, () => {}, true);  
                api.sendMessage(`‚ö†Ô∏è Could not fetch the video. Error: ${error.message}`, threadID, messageID);  
            }  
        });  
    },  
};
